import{a as Be}from"./chunk-ZY4VMQHK.js";import{a as w,b as j}from"./chunk-RCK7FPB5.js";import{A as pe,B as fe,F as he,G as ge,H as Ce,I as be,J as ve,K as _e,L as Ee,M as Se,N as xe,O as we,P as ye,Q as De,R as F,S as Me,T as Ie,U as Ue,V as Te,W as Fe,X as Re,Y as Oe,Z as ke,a as Y,b as U,d as ee,e as te,f as T,k as ie,l as m,m as re,n as oe,o as ae,p as ne,q as se,r as le,s as me,x as ue,y as de,z as ce}from"./chunk-R5U3MTBZ.js";import{a as X,l as $}from"./chunk-BIEHT63P.js";import"./chunk-IX6G3U3V.js";import{$a as l,Eb as a,Fb as n,G as E,Gb as p,Hb as S,Ib as x,Kb as z,Mc as J,Nb as g,Pb as I,Pc as K,Tb as G,Ub as W,Vb as Q,Xb as s,Y as N,Yb as C,Zb as b,ab as f,ac as Z,ca as H,da as y,e as B,ha as L,l as V,ma as D,na as M,s as q,tb as h,va as P,vb as c,wa as A}from"./chunk-ZEHKF2QA.js";var v=B(j());var Ne=B(j());var O=(()=>{let i=class i{constructor(e,r){this.http=e,this.snackBar=r}getUsuarios(){return this.http.get(`${w.API_URL}/usuarios`,{headers:{requireToken:"true"}}).pipe(E(e=>this.handlerError(e)))}saveUsuarios(e){return this.http.post(`${w.API_URL}/usuarios`,e,{headers:{requireToken:"true"}}).pipe(E(r=>this.handlerError(r)))}getRoles(){return this.http.get(`${w.API_URL}/roles`,{headers:{requireToken:"true"}}).pipe(E(e=>this.handlerError(e)))}updateUsuario(e,r){return this.http.put(`${w.API_URL}/usuarios/${e}`,r,{headers:{requireToken:"true"}}).pipe(E(t=>this.handlerError(t)))}deleteUsuario(e){return this.http.delete(`${w.API_URL}/usuarios/${e}`,{headers:{requireToken:"true"}}).pipe(E(r=>this.handlerError(r)))}handlerError(e){var r="Ocurri\xF3 un error";return e.error&&(e.error.message?r=e.error.message:r="Ocurri\xF3 un error"),Ne.default.fire({icon:"error",title:"Error",text:r,position:"top-end",toast:!0,showConfirmButton:!1,timer:3e3,timerProgressBar:!0,background:"#f8d7da",color:"#721c24"}),q(()=>{new Error(r)})}};i.\u0275fac=function(r){return new(r||i)(L(X),L(te))},i.\u0275prov=H({token:i,factory:i.\u0275fac,providedIn:"root"});let o=i;return o})();function ze(o,i){if(o&1&&(a(0,"mat-option",18),s(1),n()),o&2){let u=i.$implicit;c("value",u.id),l(),C(u.nombre)}}var _=function(o){return o.EDIT="edit",o.NEW="new",o}(_||{}),Pe=(()=>{let i=class i{constructor(e,r,t,d,je){this.data=e,this.fb=r,this.baseForm=t,this.usuariosSrv=d,this.dialogRef=je,this.hide=!0,this.roles=[],this.isReadOnly=!1,this.destroy$=new V,this.titleButton="Guardar",this.actionTODO=_.NEW,this.userForm=this.fb.group({cveusuario:[""],nombre:["",[m.required,m.minLength(3),m.maxLength(100)]],apellido:["",[m.required,m.minLength(3),m.maxLength(100)]],username:["",[m.required,m.minLength(3),m.maxLength(20)]],email:["",[m.required,m.email,m.maxLength(50)]],rol:[[],[m.required]],password:["",[m.required,m.minLength(8),m.maxLength(50)]],confirmPassword:["",[m.required,m.minLength(8),m.maxLength(50)]]})}ngOnInit(){this.pathData(),this.getRoles()}getRoles(){this.usuariosSrv.getRoles().subscribe(e=>{this.roles=e,console.log("Roles cargados:",this.roles)})}pathData(){console.log("Datos recibidos:",this.data.user),this.data.user.cveusuario?(this.titleButton="Actualizar",this.actionTODO=_.EDIT,this.isReadOnly=!0,this.userForm.patchValue({cveusuario:this.data.user.cveusuario,nombre:this.data.user.nombre,apellido:this.data.user.apellido,username:this.data.user.username,email:this.data.user.email,rol:this.data.user.rol.map(e=>e.id),password:"",confirmPassword:""})):(this.titleButton="Guardar",this.actionTODO=_.NEW,this.isReadOnly=!1)}onSave(){if(this.userForm.invalid)return;let e=this.userForm.getRawValue();if(this.actionTODO===_.NEW){let r=e.password??"";if(e.password!==e.confirmPassword){v.default.fire({icon:"error",title:"Contrase\xF1as no coinciden",text:"Las contrase\xF1as introducidas no coinciden.",position:"top-end",toast:!0,showConfirmButton:!1,timer:3e3,timerProgressBar:!0,background:"#f8d7da",color:"#721c24"});return}else if(!/[A-Z]/.test(r)||!/[!@#$%^&*(),.?":{}|<>]/.test(r)){v.default.fire({icon:"error",title:"Error",text:"La contrase\xF1a debe contener al menos una may\xFAscula y un car\xE1cter especial.",position:"top-end",toast:!0,showConfirmButton:!1,timer:3e3,timerProgressBar:!0,background:"#f8d7da",color:"#721c24"});return}this.usuariosSrv.saveUsuarios(e).pipe(N(this.destroy$)).subscribe(t=>{v.default.fire({icon:"success",title:"Usuario creado",text:"El nuevo usuario ha sido creado exitosamente.",position:"top-end",toast:!0,showConfirmButton:!1,timer:3e3,timerProgressBar:!0,background:"#d4edda",color:"#155724"}),this.dialogRef.close(!0)},t=>{}),console.log("Insert",e)}else{let r=e.password??"";if(e.password!==e.confirmPassword){v.default.fire({icon:"error",title:"Contrase\xF1as no coinciden",text:"Las contrase\xF1as introducidas no coinciden.",position:"top-end",toast:!0,showConfirmButton:!1,timer:3e3,timerProgressBar:!0,background:"#f8d7da",color:"#721c24"});return}else if(!/[A-Z]/.test(r)||!/[!@#$%^&*(),.?":{}|<>]/.test(r)){v.default.fire({icon:"error",title:"Error",text:"La contrase\xF1a debe contener al menos una may\xFAscula y un car\xE1cter especial.",position:"top-end",toast:!0,showConfirmButton:!1,timer:3e3,timerProgressBar:!0,background:"#f8d7da",color:"#721c24"});return}let t={nombre:e.nombre,apellido:e.apellido,rol:e.rol,password:r||void 0};console.log("Updating user with ID:",this.data.user.cveusuario),this.usuariosSrv.updateUsuario(this.data.user.cveusuario,t).pipe(N(this.destroy$)).subscribe(d=>{v.default.fire({icon:"success",title:"Usuario actualizado",text:"El usuario ha sido actualizado exitosamente.",position:"top-end",toast:!0,showConfirmButton:!1,timer:3e3,timerProgressBar:!0,background:"#d4edda",color:"#155724"}),this.dialogRef.close(!0)},d=>{v.default.fire({icon:"error",title:"Error al actualizar usuario",text:"Hubo un problema al actualizar el usuario. Por favor, intenta nuevamente.",position:"top-end",toast:!0,showConfirmButton:!1,timer:3e3,timerProgressBar:!0,background:"#f8d7da",color:"#721c24"})}),console.log("Update",t)}}onClear(){console.log("actionTODO en onClear:",this.actionTODO),this.actionTODO===_.NEW?this.userForm.reset():this.userForm.patchValue({nombre:"",apellido:"",rol:null})}ngOnDestroy(){this.destroy$.next({}),this.destroy$.complete()}};i.\u0275fac=function(r){return new(r||i)(f(Ie),f(le),f(Be),f(O),f(Me))},i.\u0275cmp=D({type:i,selectors:[["app-usuario-dialog"]],decls:61,vars:16,consts:[["mat-dialog-title",""],[3,"submit","formGroup"],["appearance","outline",1,"full-width"],["type","text","formControlName","nombre","matInput",""],["type","text","formControlName","apellido","matInput",""],["type","text","formControlName","username","matInput","",3,"readonly"],["type","email","formControlName","email","matInput","",3,"readonly"],[1,"full-width"],["formControlName","rol","multiple",""],[3,"value",4,"ngFor","ngForOf"],["formControlName","password","matInput","",3,"type"],["type","button","mat-icon-button","","matSuffix","",3,"click"],["formControlName","confirmPassword","matInput","",3,"type"],["align","center"],["mat-flat-button","","color","warn",1,"me-2",3,"click"],["mat-flat-button","","color","primary"],["align","end"],["mat-button","","mat-dialog-close",""],[3,"value"]],template:function(r,t){r&1&&(a(0,"h1",0),s(1,"Usuario"),n(),a(2,"mat-dialog-content")(3,"form",1),g("submit",function(){return t.onSave()}),a(4,"mat-form-field",2)(5,"mat-label"),s(6,"Nombre"),n(),p(7,"input",3),a(8,"mat-error"),s(9),n()(),a(10,"mat-form-field",2)(11,"mat-label"),s(12,"Apellidos"),n(),p(13,"input",4),a(14,"mat-error"),s(15),n()(),a(16,"mat-form-field",2)(17,"mat-label"),s(18,"Nombre de Usuario"),n(),p(19,"input",5),a(20,"mat-error"),s(21),n()(),a(22,"mat-form-field",2)(23,"mat-label"),s(24,"Correo Electronico"),n(),p(25,"input",6),a(26,"mat-error"),s(27),n()(),a(28,"mat-form-field",7)(29,"mat-label"),s(30,"Rol(es)"),n(),a(31,"mat-select",8),h(32,ze,2,2,"mat-option",9),n(),a(33,"mat-error"),s(34),n()(),a(35,"mat-form-field",2)(36,"mat-label"),s(37,"Contrase\xF1a"),n(),p(38,"input",10),a(39,"button",11),g("click",function(){return t.hide=!t.hide}),a(40,"mat-icon"),s(41),n()(),a(42,"mat-error"),s(43),n()(),a(44,"mat-form-field",2)(45,"mat-label"),s(46,"Repetir contrase\xF1a"),n(),p(47,"input",12),a(48,"button",11),g("click",function(){return t.hide=!t.hide}),a(49,"mat-icon"),s(50),n()(),a(51,"mat-error"),s(52),n()(),a(53,"div",13)(54,"button",14),g("click",function(){return t.onClear()}),s(55," Limpiar "),n(),a(56,"button",15),s(57),n()()()(),a(58,"mat-dialog-actions",16)(59,"button",17),s(60," Cerrar "),n()()),r&2&&(l(3),c("formGroup",t.userForm),l(6),b(" ",t.baseForm.getErrorMessage(t.userForm.get("nombre"))," "),l(6),b(" ",t.baseForm.getErrorMessage(t.userForm.get("apellido"))," "),l(4),c("readonly",t.isReadOnly),l(2),b(" ",t.baseForm.getErrorMessage(t.userForm.get("username"))," "),l(4),c("readonly",t.isReadOnly),l(2),b(" ",t.baseForm.getErrorMessage(t.userForm.get("email"))," "),l(5),c("ngForOf",t.roles),l(2),b(" ",t.baseForm.getErrorMessage(t.userForm.get("rol"))," "),l(4),c("type",t.hide?"password":"text"),l(3),C(t.hide?"visibility_off":"visibility"),l(2),b(" ",t.baseForm.getErrorMessage(t.userForm.get("password"))," "),l(4),c("type",t.hide?"password":"text"),l(3),C(t.hide?"visibility_off":"visibility"),l(2),b(" ",t.baseForm.getErrorMessage(t.userForm.get("confirmPassword"))," "),l(5),b(" ",t.titleButton," "))},dependencies:[J,ae,ie,re,oe,ne,se,U,ee,T,fe,pe,ue,de,ce,Te,Fe,Oe,Re,De,Y]});let o=i;return o})();var k=B(j());var Ge=()=>[5,10,20,100];function We(o,i){o&1&&(a(0,"th",16),s(1,"Nombre"),n())}function Qe(o,i){if(o&1&&(a(0,"td",17),s(1),n()),o&2){let u=i.$implicit;l(),C(u.nombre)}}function Ze(o,i){o&1&&(a(0,"th",16),s(1,"Apellidos"),n())}function Je(o,i){if(o&1&&(a(0,"td",17),s(1),n()),o&2){let u=i.$implicit;l(),C(u.apellido)}}function Ke(o,i){o&1&&(a(0,"th",16),s(1,"Usuario"),n())}function Xe(o,i){if(o&1&&(a(0,"td",17),s(1),n()),o&2){let u=i.$implicit;l(),C(u.username)}}function Ye(o,i){o&1&&(a(0,"th",16),s(1,"Rol"),n())}function et(o,i){if(o&1&&(a(0,"td",17),s(1),n()),o&2){let u=i.$implicit,e=I();l(),C(e.getRolesDisplay(u.rol))}}function tt(o,i){o&1&&p(0,"th",16)}function it(o,i){if(o&1){let u=z();a(0,"td",18)(1,"button",19),g("click",function(){let r=P(u).$implicit,t=I();return A(t.onOpenModal(r,t.Action.EDIT))}),a(2,"mat-icon"),s(3,"edit"),n(),s(4," Editar "),n(),a(5,"button",20),g("click",function(){let r=P(u).$implicit,t=I();return A(t.onDeleteUsuario(r.cveusuario))}),a(6,"mat-icon"),s(7,"delete"),n(),s(8," Eliminar "),n()()}}function rt(o,i){o&1&&p(0,"tr",21)}function ot(o,i){o&1&&p(0,"tr",22)}var Ae=(()=>{let i=class i{constructor(e,r){this.dialog=e,this.usuariosSrv=r,this.roles=[],this.Action=_,this.dataSource=new ye,this.displayedColumns=["nombre","apellido","username","rol","acciones"]}ngOnInit(){this.getUsuarios()}getUsuarios(){this.usuariosSrv.getUsuarios().subscribe({next:e=>{e.sort((r,t)=>(r.cveusuario||0)-(t.cveusuario||0)),this.dataSource.data=e},error:e=>{console.error("Error al obtener usuarios",e)}})}getRolesDisplay(e){return e.map(r=>r.nombre).join(", ")}onDeleteUsuario(e){k.default.fire({title:"\xBFEst\xE1s seguro?",text:"No podr\xE1s revertir esta acci\xF3n",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"S\xED, eliminar",cancelButtonText:"Cancelar"}).then(r=>{r.isConfirmed&&this.usuariosSrv.deleteUsuario(e).subscribe({next:()=>{k.default.fire("Eliminado","El usuario ha sido eliminado.","success"),this.getUsuarios()},error:t=>{k.default.fire("Error","Ocurri\xF3 un error al eliminar el usuario.","error"),console.error("Error al eliminar usuario",t)}})})}ngAfterViewInit(){this.dataSource.paginator=this.paginator}onOpenModal(e={},r){this.dialog.open(Pe,{maxWidth:"100%",width:"80%",data:{user:e,action:r}}).afterClosed().subscribe(d=>{d&&this.getUsuarios()})}ngOnDestroy(){}};i.\u0275fac=function(r){return new(r||i)(f(Ue),f(O))},i.\u0275cmp=D({type:i,selectors:[["app-usuarios"]],viewQuery:function(r,t){if(r&1&&G(F,5),r&2){let d;W(d=Q())&&(t.paginator=d.first)}},decls:27,vars:5,consts:[[1,"m-3"],["align","right"],["mat-flat-button","","color","primary",1,"m-2",3,"click"],[1,"table-content","mat-elevation-z8","m-4"],["mat-table","",3,"dataSource"],["matColumnDef","nombre"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","apellido"],["matColumnDef","username"],["matColumnDef","rol"],["matColumnDef","acciones"],["mat-cell","","class","text-center",4,"matCellDef"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["showFirstLastButtons","true",3,"pageSizeOptions"],["mat-header-cell",""],["mat-cell",""],["mat-cell","",1,"text-center"],["mat-flat-button","","color","accent",1,"me-2",3,"click"],["mat-flat-button","","color","warn",3,"click"],["mat-header-row",""],["mat-row",""]],template:function(r,t){r&1&&(a(0,"h3",0),s(1,"Usuarios"),n(),a(2,"div",1)(3,"button",2),g("click",function(){return t.onOpenModal({},t.Action.NEW)}),a(4,"mat-icon"),s(5,"add"),n(),s(6," Agregar "),n()(),a(7,"div",3)(8,"table",4),S(9,5),h(10,We,2,0,"th",6)(11,Qe,2,1,"td",7),x(),S(12,8),h(13,Ze,2,0,"th",6)(14,Je,2,1,"td",7),x(),S(15,9),h(16,Ke,2,0,"th",6)(17,Xe,2,1,"td",7),x(),S(18,10),h(19,Ye,2,0,"th",6)(20,et,2,1,"td",7),x(),S(21,11),h(22,tt,1,0,"th",6)(23,it,9,0,"td",12),x(),h(24,rt,1,0,"tr",13)(25,ot,1,0,"tr",14),n(),p(26,"mat-paginator",15),n()),r&2&&(l(8),c("dataSource",t.dataSource),l(16),c("matHeaderRowDef",t.displayedColumns),l(),c("matRowDefColumns",t.displayedColumns),l(),c("pageSizeOptions",Z(4,Ge)))},dependencies:[U,T,he,Ce,Ee,be,ge,Se,ve,_e,xe,we,F]});let o=i;return o})();var at=[{path:"",component:Ae}],$e=(()=>{let i=class i{};i.\u0275fac=function(r){return new(r||i)},i.\u0275mod=M({type:i}),i.\u0275inj=y({imports:[$.forChild(at),$]});let o=i;return o})();var At=(()=>{let i=class i{};i.\u0275fac=function(r){return new(r||i)},i.\u0275mod=M({type:i}),i.\u0275inj=y({imports:[K,$e,me,ke]});let o=i;return o})();export{At as UsuariosModule};
